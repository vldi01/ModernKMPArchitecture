# AI Project Overview: ModernArchitecture KMP Template

This document provides a structured summary of the project for Large Language Models.

## Core Principles & Dogmas

1.  **Contract-First Architecture**: The primary principle. API contracts are defined in a shared KMP module (`network/api`). These contracts, using Ktorfit annotations, are the single source of truth for both client-side network generation and server-side route generation. This ensures full-stack type safety at compile time.
2.  **API/Implementation Separation**: Every feature is split into two modules: `:api` and `:impl`.
    *   `:api`: The public contract. Contains navigation destinations, public interfaces, and database entities/DAOs. Other modules depend on this.
    *   `:impl`: The private implementation. Contains UI, ViewModels, DI setup, and navigation logic. No other feature module is allowed to depend on an `:impl` module. This enforces strict encapsulation and improves incremental build times.
3.  **Just-in-Time Architecture**: Rejects premature abstraction. Architectural patterns like repositories or use cases are only introduced when complexity warrants them, not as a default.
4.  **Functional Package Structure**: Feature implementation (`:impl`) modules are structured by function (`ui/`, `logic/`, `data/`) rather than by layer (`view/`, `viewmodel/`, `repository/`).

## Module Structure Breakdown

-   **`network/`**: The core of the full-stack contract.
    -   `network/api`: Contains Kotlin interfaces with Ktorfit annotations (e.g., `AuthApi`). This is the single source of truth for all network communication.
    -   `network/core`: Provides shared networking infrastructure, including the Ktor client builder, `safeApiCall` wrapper, and security annotations (`@NoAuth`, `@AuthJwt`).
    -   `network/serverProcessor`: A custom KSP (Kotlin Symbol Processing) module. It reads the interfaces from `network/api` and generates the corresponding Ktor server routing code.

-   **`client/`**: The frontend KMP application.
    -   `client/features/`: Contains all business features, each split into `:api` and `:impl` modules (e.g., `client/features/auth/api`, `client/features/auth/impl`).
    -   `client/database`: A central Room KMP database module. It depends on all feature `:api` modules to aggregate their `@Entity` definitions into a single `AppDatabase`.
    -   `client/navigation`: A decoupled navigation engine using a registry pattern. Navigation is performed via type-safe `Destination` objects. The system works by retrieving a list of all `ScreenInjector` modules from Koin, allowing each feature to register its screens independently.
    -   `client/resources`: Shared Compose Multiplatform resources (strings, drawables).
    -   `client/core`: The main entry point for the client-side DI graph and application logic.

-   **`composeApp/`**: The application shell. It contains the platform-specific entry points (`MainActivity` for Android, `Main.kt` for Desktop, `MainViewController` for iOS) and is responsible for initializing Koin and setting up the root UI.

-   **`server/`**: The Ktor backend application. It implements the interfaces defined in `network/api`. Its routing is not written manually but is generated by the `network/serverProcessor`, which binds the API implementations (provided via Koin) to HTTP routes.

-   **`buildSrc/`**: Manages build logic using Gradle Convention Plugins to ensure consistency and avoid duplication across the numerous modules.

## Key Technical Implementations

-   **Networking**:
    -   **Client**: Ktorfit generates HTTP client implementations from the `network/api` interfaces.
    -   **Server**: The custom `serverProcessor` KSP generates Ktor routing from the same interfaces. This creates a compile-safe link between client and server.
-   **State Management**: Unidirectional Data Flow (UDF), similar to MVI.
    -   **State**: Immutable data class.
    -   **Event**: Sealed interface for user/system actions.
    -   **ViewModel**: Manages state via `StateFlow` and processes events through a single `onEvent` function.
-   **Database**:
    -   **Library**: Room for KMP with an SQLite driver.
    -   **Architecture**: `@Entity` classes and DAO interfaces are defined in each feature's `:api` module to prioritize feature encapsulation and co-location of related code. The central `:database` module depends on all feature `:api` modules to build the complete `AppDatabase`. This is a known trade-off accepted to maintain feature modularity.
-   **Dependency Injection**:
    -   **Library**: Koin with Koin Annotations (`@KoinViewModel`, `@Single`, `@Module`).
-   **Security**:
    -   **Flow**: A Ktor Client Plugin inspects API annotations (`@AuthJwt`) to automatically inject bearer tokens.
    -   **Storage**: A `TokenStore` interface is used. The default implementation uses Room with plain-text storage (not production-safe).
    -   **Refresh**: No automatic token refresh logic is implemented. `401` errors must be handled manually by the ViewModel.
-   **Testing**:
    -   **Stack**: `kotlin-test`, `kotlinx-coroutines-test`, and `Mokkery` for mocking.
    -   **Location**: Unit tests are in the `commonTest` source set of `:impl` modules.
